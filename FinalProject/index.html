<!DOCTYPE html>
<html>

<head>
</head>

<body>
<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.4.min.js"></script>

<h1>BusNotifier</h1>

<input type="datetime-local" id="Arrival Time" value=2016-10-17T17:45></input>

<input type="number" id="destlat" value=47.609661></input>

<input type="number" id="destlon" value=-122.337795></input>

<button type="button" onclick="postLocation()">Get Nearby Bus Stops</button>

<button type="button" onclick="postAuth()">Authorize Google Calendar</button>

<p>Spoof Your Location</p>

<input type="number" id="destlat" value=47.755944></input>

<input type="number" id="destlon" value=-122.345626></input>

<p id="myLocation"></p>

<script>
var lat = 47.755944.toString();
var lon = -122.345626.toString();

navigator.geolocation.getCurrentPosition = function(success, failure) {
    success({ coords: {
        latitude: lat,
        longitude: lon,

    }, timestamp: Date.now() });
}

function getLocation(){
  if(navigator.geolocation){
    var geo = navigator.geolocation;
    geo.getCurrentPosition(showLocation, error)
  }
}

function showLocation(result){
  document.getElementById("myLocation").innerHTML = "Lat: "+result.coords.latitude+" Long: "+result.coords.longitude
}

function error(error){
  alert("An error has occured")
}

function postLocation() {
  var destlat = document.getElementById("destlat").value;
  var destlon = document.getElementById("destlon").value;
  var arrivaltime = document.getElementById("Arrival Time").value;
  var arrival = arrivaltime.replace(":"," ");
  console.log(arrivaltime);
  body = {};
  body['origin'] = {"lat":lat,"lon":lon};
  body['destination'] = {"lat":destlat,"lon":destlon};
  body['arrival'] = arrival;
  //body = { "origin": {"lat":'+lat+',"lon":'+lon+'}, "destination": {"lat":'+destlat+',"lon":'+destlon+'}, "arrival":'+arrival+' }
  console.log(body)
    $.ajax({
        type: "POST",
        url: "/dispatcher.py",
        data: JSON.stringify(body),
        success: testcallbackFunc
    });
}

function postAuth() {
  window.location = 'https://accounts.google.com/o/oauth2/auth?client_id=434441611865-vb041elv7otsm7a7ujbgujmhu0e4go32.apps.googleusercontent.com&response_type=code&redirect_uri=http%3A%2F%2F127.0.0.2%3A8000&scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcalendar&access_type=offline';
}

/*function postAuth() {
    $.ajax({
        type: "POST",
        url: "/dispatcher.py?func=authenticate",
        data: '{ "location": {"lat":'+lat+',"lon":'+lon+'} }',
        success: callbackAuth
    });
}*/

/*function callbackFunc(response) {
  setInterval(updateCalendar(){
    $.ajax({
        type: "POST",
        url: "/dispatcher.py?func=update",
        data: response,
    });
  },60000);
}*/

function testcallbackFunc(response) {
  console.log(response);
  var trip = JSON.parse(response);
  var stopId = trip['stopId'];
  var serviceDate = trip['servicedate'];
  var tripId = trip['tripId'];
  var arrivalTime = trip['arrivalTime']
  window.location = 'https://accounts.google.com/o/oauth2/auth?client_id=434441611865-vb041elv7otsm7a7ujbgujmhu0e4go32.apps.googleusercontent.com&response_type=code&redirect_uri=http%3A%2F%2F127.0.0.2%3A8000&scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcalendar&access_type=offline&state='+stopId+'-'+serviceDate+'-'+tripId+'-'+arrivalTime;
}

function callbackAuth(response) {
  var auth = JSON.parse(response);
  window.location = auth.auth_uri;
}

</script>
</body>
</html>
